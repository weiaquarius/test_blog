<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">  
  <link rel = "stylesheet"
    href = "https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">
  <link href="assets/img/LOGO.png" rel="shortcut icon" />
 
  
  <link href="assets/img/LOGO.png" rel="apple-touch-icon-precomposed" />
  <link rel="stylesheet" href="assets/css/index.css">
  <link rel="stylesheet" href="assets/css/same.css">
  <!-- <link rel="stylesheet" href="/assets/css/style.css"> -->

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital@1&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Staatliches&display=swap" rel="stylesheet">

  <!-- <link rel="stylesheet" href="sweetalert2.min.css"> -->

  <!------- jQUERY -------->
  <!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script> -->
  
  <!-- show image (fade_in) -->
  <script src="http://fb.me/react-0.8.0.js"></script>
  <script src="http://fb.me/JSXTransformer-0.8.0.js"></script>
  <!-- <script src="http://code.jquery.com/jquery-1.10.0.min.js"></script> -->
  
  <script src="scripts/jquery-3.5.1.js"></script>
  <script src="scripts/jquery-3.5.1.min.map"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
  

  <!-- bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
   <!-- bootstrap -->
   <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
   
   
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script> -->
  
   

  <!-- firebase -->
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-analytics.js"></script>
  <!-- database -->
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-database.js"></script>  
  <!-- storage -->
  <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-storage.js"></script>  
    <!-- Compiled and minified JavaScript -->
    
  <!-- <link rel = "stylesheet"
  href = "https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.3/css/materialize.min.css">    
             -->
  
  
 
  <title>Blog</title>
  </head>
  <body class="grey lighten-3">
    <!-- NAVBAR -->
    <div class="wrapper">
      <nav class="grey lighten-4">
        <div class="nav-wrapper container">
          <a href="MainPage.html" class="brand-logo">
            <img src="assets/img/LOGO.png" style="width: 120px;cursor:default;">
          </a>
          
          <ul id="nav-mobile" class="right hide-on-med-and-down">
            <li>
                <a class="grey-text" id="create_post1" style="font-size: 1.1rem;font-weight: bolder;" onclick="switchView('home.html')">文章列表</a>
            </li>
            <li>
              <a class="grey-text show_post hidden" data-toggle="modal" data-target="#modal-create" style="font-size: 1.1rem;font-weight: bolder;">新增文章</a>
            </li>
            <li>
              <a href="#" class="grey-text" id="create_post2" style="font-size: 1.1rem;font-weight: bolder;" onclick="switchView('myposts.html')">我的文章</a>
            </li>
            <li>
              <a href="#" class="grey-text "  id="create_post3" style="font-size: 1.1rem;font-weight: bolder;" onclick="switchView('myaccount.html')">我的帳戶</a>
            </li>
            <li>
              <a href="#" class="grey-text" id="btn-logout" style="font-size: 1.1rem;font-weight: bolder;">登出</a>
            </li>            
          </span>
        </ul>
          <div class="menu right">
              <img src="assets/boot.png" alt="">
          </div>
          <div class="hamburger">
            <div class="close">
                <div class="close-img"><img src="assets/img/close.png" alt=""></div>
            </div>
            <p class="black-text" id="create_post1_rwd" onclick="switchView('home.html')">文章列表</p>
            <p class="black-text show_post hidden" data-toggle="modal" data-target="#modal-create">新增文章</p>
            <p class="black-text" id="create_post2_rwd" onclick="switchView('myposts.html')">我的文章</p>
            <p class="black-text" id="create_post3_rwd" onclick="switchView('myaccount.html')">我的帳戶</p>
            <p class="black-text" id="btn-logout-rwd">登出</p>
          </div>
        </div>
      </nav>
      
      <div class="logged-out">
        <div style="height: 50px;"></div>
      </div>
  
    <!-- SIGN UP MODAL -->
    <!-- <div id="modal-signup" class="modal">
      <div class="modal-content">
        <div class="contact-us"> 
          <span class = "card-title"></span>                 
          <h4>註冊 Sign up</h4><br />
          <form action="#" id="signup-form">
            <label for="username" style="font-family:Microsoft JhengHei;">使用者名稱NAME<em>&#x2a;</em></label>
            <input id="username" name="username" required="" type="text" />
  
            <label for="signup-email" >郵件EMAIL<em>&#x2a;</em></label>
            <input id="signup-email" name="signup-email" required="" type="email" />
  
            <label for="signup-password">密碼PASSWORD<em>&#x2a;</em></label>
            <input id="signup-password" name="signup-password" required="" type="password"  />
            
            <button class="btn btn-primary" type="button" id="check" style="background:#1E2D61;">確定</button>
            <p class="error center-align" ></p>
          </form>
        </div>
      </div>
    </div> -->
  
    
    <!-- ACCOUNT MODAL -->
    <!-- <div id="modal-account" class="modal">
      <div class="modal-content center-align">
        <h2 style="text-align: center;margin-bottom: 30px;font-weight:bold;">我的帳戶</h2 style="text-align: center;">
          <br>
          <hr>
          <br><br><br>
          <div class="container">
              <div class="row">
              <div class="col-md-2"></div>
              <div class="col-sm-12 col-md-8" id="mycontent">
              </div>
              <div class="col-md-2"></div>
              </div>
          </div>
          <br>
      </div>
    </div>
    <script>
      firebase.auth().onAuthStateChanged(function(user){
          if (user){
              
              var userID = firebase.auth().currentUser.uid;
              var personal = "";
              var databaseRef = firebase.database().ref('Users/' + userID).once('value').then(function(snapshot){
                  
                  personal      += "<div class='container' style='text-align:center;'>"
                      personal  += "<h4 style='font-weight:bold;'>使用者名稱: </h4>" + "<p>" + snapshot.val().username + "</p>"
                      personal  += "<h4 style='font-weight:bold;'>興趣嗜好: </h4>" + "<p>" + snapshot.val().interest + "</p>"
                  personal      += "</div>";
                  personal      += "<div style='height:200px;'></div>"
                  console.log(personal);    
  
                  //         personal  += "<div style='font-size:22px; font-weight:bold;'><h4 style='font-weight:bold;'>";
                  //     personal  += "標題: "  + "</h4></div>" 
                  //             +  "<p>" + snapshot.val().username
                  // personal    += "</p> <br>";
                  $('#mycontent').html(personal);
              });
              // console.log(personal);
              
          }
      });
  </script> -->
  
    <!-- CREATE GUIDE MODAL -->
    <!-- <div id="modal-create" class="modal" style="overflow: scroll;">
      <div class="modal-content">
        <div class="contact-us">
          
          <h4>新增文章Create Post</h4><br />
          <form action="#" id="create-post">
            <div class="form-group">
              <input type="file" class="form-control-file" id="main-image">
              <div class="invalid-feedback">
                請選擇一張背景照片
              </div>
            </div>
            <div class="form-group">
              <img id="selected-image" width="250" height="150" src="#" alt="背景圖片">
            </div>
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: 2%;" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100" id="upload-progress">0%</div>
            </div>
            <div class="form-group">
              <label for="title" style="font-family:Microsoft JhengHei;">文章標題TITLE<em>&#x2a;</em></label>
              <input id="title" name="title" required="" type="text" />
            </div>
            
            <div class="form-group">
              <label for="content" style="font-family:Microsoft JhengHei;">文章內容CONTENT<em>&#x2a;</em></label>
              <textarea id="content" name="content" required="" rows="4"></textarea>
            </div>
            <div class="form-group">
              <button class="btn btn-primary" style="background:#1E2D61;margin-top:20px;">確定</button>
            </div>
            
          </form>
        </div>
      </div>
    </div> -->
  
    

    <div id="modal-create" class="modal fade" aria-hidden="true" aria-labelledby="ModalTitle" style="overflow: scroll;">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="contact-us">
            <!-------------- POST AREA ------------------>
            <script>
              var counter = 0;
            </script>
            <div class="modal-header">
              <h4 id="ModalTitle" class="modal-title">新增文章Create Post</h4><br />
            </div>
            <div class="modal-body">
              <form action="#" id="create-post">
              
                <div class="form-group">
                  <label for="title" style="font-family:Microsoft JhengHei;">文章標題TITLE<em>&#x2a;</em></label>
                  <input id="title" name="title" required="" type="text" />
                  <div class="invalid-feedback">
                    請輸入文章標題
                  </div>
                </div>
                
                <div class="form-group">
                  <label for="content" style="font-family:Microsoft JhengHei;">文章內容CONTENT<em>&#x2a;</em></label>
                  <textarea id="main-desc" name="content" required="" rows="5"></textarea>
                  <div class="invalid-feedback">
                    請輸入文章內容
                  </div>
                </div>
                <div class="form-group">
                  <label for="image" style="font-family:Microsoft JhengHei;">背景照片IMAGE<em>&#x2a;</em></label>
                  <input type="file" class="form-control-file" id="main-image">
                  <div class="invalid-feedback">
                    請選擇一張背景照片
                  </div>
                </div>
                <div class="form-group">
                  <img id="selected-image" width="60%" height="300px" src="#" alt="背景圖片">
                </div>
                <div class="form-group">
                  <div class="progress bg-secondary">
                    <div class="progress-bar bg-success" id="upload-progress" style="width:0%;">0%</div>
                    </div>
                </div>

                <div id="result">
    
                </div>
                <div class="form-group" style="margin-top:30px;">
                  <button class="btn btn-primary" type="button" id="save-post" style="background:#1E2D61;margin-top:10px;">確定</button>
                </div>
                <div class="form-group" style="margin-top:30px;">
                  <button class="btn btn-primary" type="button" style="background:#485da8;margin-top:10px;margin-right:30px;" data-dismiss="modal">關閉</button>
                </div>
              </form>                
            </div>
          </div>
        </div>
      </div>
    </div>
        
    <div id="container">
      <div class="row" style="margin:0;">
        <div class="col" style="width:200px;height:50px;"></div>
      </div>
      <div class="row">
        <!-- <div class="col-md-1"></div> -->
        <div class="col-sm-12 col-md-6">
          <h2 class="title" style="text-align: center !important;">Welcome to my Blog~~</h2>
          <h4 class="title" style="text-align: center !important;font-size: 24px;font-family:Microsoft JhengHei;">查看「文章列表」</h4>
          
        </div>
        <div class="col-sm-12 col-md-6">
          <div class="mainpage-image">
            <img src="assets/img/girl.png" width="250" alt="svg">
          </div>
        </div>
      </div>
    </div>
    
    <script>
      var validImagetypes = ["image/gif", "image/jpeg", "image/png"];

      $("#selected-image").hide();

      function previewImage(image_post){
      if (image_post.files && image_post.files[0]){
          var reader = new FileReader();
          reader.onload = function(e){
          $("#selected-image").attr('src',e.target.result);
          $("#selected-image").fadeIn();
          }
          reader.readAsDataURL(image_post.files[0]);
          // $("#selected-image").show();
          }
      }

      $("#main-image").change(function(){
      previewImage(this);
      });

      $("#save-post").click(function(){

      var title = $("#title").val();
      var desc = $("#main-desc").val();
      var picture = $("#main-image").prop("files")[0];

      $("#main-desc").removeClass("is-invalid");
      $("#title").removeClass("is-invalid");
      $("#main-image").removeClass("is-invalid");

      if (!title){
          
          $("#title").addClass("is-invalid");
          return;
      }
      if (!desc){
          $("#main-desc").addClass("is-invalid");
          return;
      }
      if (picture == null){
          $("#main-image").addClass("is-invalid");
          return;
      }
      if($.inArray(picture["type"], validImagetypes)<0){
          $("#main-image").addClass("is-invalid");
          return;
      }

      // Upload and save to firebase

      var databaseRef = firebase.database().ref().child("blog");

      databaseRef.once("value").then(function(snapshot){
          var name = picture['name'];
          var dataStr = new Date().getTime();
          var fileCompleteName = name + "_" + dataStr;
          
          var storageRef = firebase.storage().ref("post images");
          var poststorageRef = storageRef.child(fileCompleteName);

          var uploadTask = poststorageRef.put(picture);

          uploadTask.on("state_changed",
          
              function progress(snapshot){
              var percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              $("#upload-progress").html(Math.round(percentage) + "%");
              $("#upload-progress").attr("style", "width:" + percentage + "%");
              },
              function error(err){
              
              },
              function complete(){
              var user = firebase.auth().currentUser;
              var userName;
              firebase.database().ref('Users/' + user.uid).once('value').then(function(snapshot){
                  var fName = (snapshot.val() && snapshot.val().username);
                  userName = fName;
              });
              console.log(userName);
              uploadTask.snapshot.ref.getDownloadURL().then(function(downloadUrl){
                  var time = new Date();

                  var options = {
                  year:"numeric",
                  month:"long",
                  day:"2-digit",
                  weekday:"long",
                  };

                  var postData = {
                  
                  "image" : downloadUrl,
                  "name" : fileCompleteName,
                  "desc" : desc,
                  "title" :title,
                  "uid" :user.uid,
                  "counter" : 5000 - counter,
                  "username" : userName,
                  "time": time.toLocaleDateString('Taiwan',{hour:"numeric",minute:"numeric", hour12:true}),
                  "date" : time.toLocaleDateString('Taiwan',options),
                  };
                  // console.log(options,postData);
                  console.log(userName);
                  var newPostRef = databaseRef.push();

                  newPostRef.set(postData, function(err){
                  if (err){
                      console.log("失敗");
                      $("#result").attr("class", "alert alert-danger");
                      $("#result").html(err.message);
                  }
                  else {
                      // console.log("成功");
                      $("#result").attr("class", "alert alert-success");
                      $("#result").html("成功上傳貼文!");
                      // $("#modal-create").modal('remove');
                      window.open("","_self");
                  }
                  resetForm();
                  });
                });
              }
            );
        });

      });
      function resetForm(){
    
          $("#create-post")[0].reset();
          $("#selected-image").fadeOut();
          $("#upload-progress").html("completed");
      }
    </script>
    
    <div style="height: 270px;"></div>
    <footer class = "footer" style = "background-color: rgb(42, 55, 80);">
      <div class="container" style="padding-top: 30px;">
        <div class = "row">
          <div class="col-md-2"></div>
            <div class = "col-sm-12 col-md-10">
              <h5 class = "white-text">Vivian's Blog</h5>
            </div>
          </div>    
          <div class="row">
            <div class="col-sm-4 col-md-2"></div>
            <div class = "col-sm-4 col-sm-12 col-md-10">
              <!-- <ul>
                  <li><a href = "#" class = "grey-text text-lighten-4 align-center">
                    關於我</a></li>
              </ul> -->
            </div>
            <div class="col-sm-4"></div>
          </div>
        
        
        <div class="row">
          <div class="col-sm-4 col-md-2"></div>
          <div class="col-sm-4 col-md-10 grey-text text-lighten-4">
            © 2020 
          </div>
          <div class="col-sm-4"></div>
        </div>     
      </div>  
    </footer>
  </div>

  <script src="scripts/same.js"></script>
  <script>
    firebase.auth().onAuthStateChanged(function(user){
      if (!user){
        window.location.href = "index.html";
      }
    })
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@9"></script>
<!-- <script src="scripts/auth.js"></script>
<script src="scripts/index.js"></script> -->

  
</body>